# Zsh configuration
# Starship prompt is managed by mise

source "$HOME/scripts/common/utils.sh"

: "${ZDOTDIR:=~/.zsh}"

function source_zsh_script() {
  local name="$1"
  source "$HOME/config/zsh/$name.zsh"
}

# Language
## 日本語ファイル名を表示可能にする
setopt print_eight_bit

# 単語の区切り文字を指定
autoload -Uz select-word-style
select-word-style default
## ここで指定した文字は単語区切りとみなされる
## / も区切りと扱うので、^W でディレクトリ１つ分を削除できる
zstyle ':zle:*' word-chars " /=;@:{},|"
zstyle ':zle:*' word-style unspecified

# Workaround for GUI app which doesn't get /etc/paths
export PATH="$PATH:$(cat /etc/paths | xargs | tr " " :)"

# Lib
# Load performance optimizations first
source_zsh_script performance

# Core modules
source_zsh_script common
source_zsh_script settings
source_zsh_script history

# Interactive modules (defer loading when possible)
source_zsh_script complete
source_zsh_script keybinding
source_zsh_script alias

# Development tools
source_zsh_script git

# OS-specific optimizations
source_zsh_script os

# Optional modules (enable as needed):
# source_zsh_script fzf    # Enable if using fzf integration
# source_zsh_script python # Deprecated - Python managed by mise

# Legacy configurations (managed by sheldon now):
# - zsh-autosuggestions: managed via sheldon plugins
# - google-cloud-sdk: install manually if needed

# Bun (defer loading)
if [ -d "$HOME/.bun" ]; then
  [ -s "$HOME/.bun/_bun" ] && source "$HOME/.bun/_bun"
  export BUN_INSTALL="$HOME/.bun"
  export PATH="$BUN_INSTALL/bin:$PATH"
fi

# mise activate (must be before starship/sheldon for mise-managed tools)
# --no-hook-env: skip precmd hook (~460ms overhead per prompt)
# chpwd hook: run hook-env only on directory change for env var updates
if is_exists "$HOME/.local/bin/mise"; then
  __mise_bin="$HOME/.local/bin/mise"
elif is_exists "/opt/homebrew/bin/mise"; then
  __mise_bin="/opt/homebrew/bin/mise"
fi
if [[ -n "${__mise_bin:-}" ]]; then
  eval "$($__mise_bin activate zsh --no-hook-env)"
  _mise_hook_chpwd() { eval "$($__mise_bin hook-env -s zsh)"; }
  typeset -ag chpwd_functions
  if [[ -z "${chpwd_functions[(r)_mise_hook_chpwd]+1}" ]]; then
    chpwd_functions=( _mise_hook_chpwd ${chpwd_functions[@]} )
  fi
  _mise_hook_chpwd
fi

# Tools depending on mise-managed binaries (nvim, etc.)
source_zsh_script vim

# sheldon (zsh plugin manager) - defer loading
if command -v sheldon >/dev/null 2>&1; then
  eval "$(sheldon source)"
fi

# starship prompt (modern cross-shell prompt) - defer loading
if command -v starship >/dev/null 2>&1; then
  eval "$(starship init zsh)"
fi

# Ghostty shell integration (for working directory tracking in splits)
if [[ -n "$GHOSTTY_RESOURCES_DIR" ]]; then
  source "${GHOSTTY_RESOURCES_DIR}/shell-integration/zsh/ghostty-integration"
fi

# pipx
export PATH="$PATH:$HOME/.local/bin"

# Android Studio
export PATH="$PATH:$HOME/Library/Android/sdk/platform-tools"

# Rust
export PATH="$PATH:$HOME/.cargo/bin"

# Package manager configurations:
# - Homebrew: system packages managed via Brewfile
# - mise: handles runtimes, CLI tools, and Node.js/Python versions

if command -v gwq >/dev/null 2>&1; then
  source <(gwq completion zsh)
fi

export PATH="$HOME/bin:$PATH"

# vim:set ft=zsh:
# bun completions

# Added by Antigravity
export PATH="$HOME/.antigravity/antigravity/bin:$PATH"

if command -v wt >/dev/null 2>&1; then eval "$(command wt config shell init zsh)"; fi

# Local overrides (not managed by dotfiles)
[[ -f ~/.zshrc.local ]] && source ~/.zshrc.local

# Turso
if command -v turso >/dev/null 2>&1; then
  export PATH="$PATH:$HOME/.turso"
fi

## jj
autoload -U compinit
compinit
source <(jj util completion zsh)
